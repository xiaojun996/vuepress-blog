---
title: 使用patch-package修改node_modules下包内容
date: 2021-04-12 21:28:16
permalink: /pages/074681/
categories:
  - Node
---

使用 patch-package 修改项目依赖包内容（node_modules 里），为依赖包创建个性补丁。

<!-- more -->

### 前言

今天我遇到了需要修改项目 **依赖库的源代码** 的需求，在使用 pdf.js 做 pdf 预览时候，签章图片、签名未能正常显示，需要修改源代码，但是我们不会把 **node_modules** 提交到 **Git 服务器** 上。如果要下载这库拷贝到项目里，又太过麻烦，太过复杂，这时候就轮到我们的 [patch-package](https://www.npmjs.com/package/patch-package) 出场了～

### 安装

:::: tabs type:board-card

::: tab npm 版 lazy

```shell
npm i patch-package
```

:::

::: tab yarn 版 lazy

```shell
yarn add patch-package postinstall-postinstall
```

:::

::::

### 部署

在 package.json 里

```diff
 "scripts": {
+  "postinstall": "patch-package"
 }
```

### 修复 Bug

```shell
# 修复您的一个依赖项中的错误
vim node_modules/some-package/xxx.js
```

### 制作 patches(补丁)

:::: tabs type:board-card

::: tab npm 版 lazy

```shell
npx patch-package package-name
```

:::

::: tab yarn 版 lazy

```shell
yarn patch-package package-name
```

:::

::::

制作完补丁后，会在项目根目录 **patches** 目录里生成 <span style="background: #ddd; color: red;">package-name + version.patch</span> 的文件，这样每次 **npm install** 时候，就会自动打上补丁了（[这里是用上了npm install 生命周期的钩子](https://docs.npmjs.com/cli/v7/using-npm/scripts)）

<DynamicImportPhotoSwipe 
  :items="[{src: 'https://cdn.jsdelivr.net/gh/xiaojun996/CDN/images/screenshot/patch-package.png',thumbnail: 'https://cdn.jsdelivr.net/gh/xiaojun996/CDN/images/screenshot/patch-package.png',w: 1048,h: 560},{src: 'https://cdn.jsdelivr.net/gh/xiaojun996/CDN/images/screenshot/patch-package0.png',thumbnail: 'https://cdn.jsdelivr.net/gh/xiaojun996/CDN/images/screenshot/patch-package0.png',w: 991,h: 675}]"
/>
