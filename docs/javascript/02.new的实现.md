---
title: new的实现
date: 2020-08-29 23:38:34
permalink: /pages/b254ff/
categories:
  - JavaScript
tags:
  - JavaScript
  - new
---

### 代码

```JavaScript
const newOperator = (function () {
  const _stack = []
  function newOperator(func) {
    if (typeof func !== 'function') {
      throw new TypeError('newOperator function the first param must be a function')
    }
    newOperator.target = func
    const newObj = Object.create(func.prototype)
    const result = func.apply(newObj, [].slice.call(arguments, 1))
    newOperator.target = null
    return (typeof result !== 'object' && result !== null) || typeof result !== 'function' ? result : newObj
  }

  Reflect.defineProperty(newOperator, 'target', {
    get() {
      return _stack[_stack.length - 1]
    },
    set(target) {
      if (target === null) {
        _stack.pop()
      } else {
        _stack.push(target)
      }
    },
  })

  return newOperator
})()

function B() {
  if (newOperator.target === B) {
    console.log('new调用 B')
  } else {
    console.log('非new调用 B')
  }
  return { balabala: 123 }
}

function A() {
  const b = newOperator(B)
  if (newOperator.target === A) {
    console.log('new调用 A')
  } else {
    console.log('非new调用 A')
  }
}
newOperator(A)

```

### 运行结果

- new 调用 B
- new 调用 A
