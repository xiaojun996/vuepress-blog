---
title: 限制并发请求数
date: 2021-08-30 22:33:48
permalink: /pages/45fa21/
categories:
  - JavaScript
tags:
  - Promise
---

```ts
type RequestFn = () => Promise<string | void>
type CreateRequest = (delay: number) => RequestFn
const concurrentRequest = (requestFns: RequestFn[], limit: number): void => {
  // 递归函数
  function recursion(requestFn: RequestFn | undefined): void {
    requestFn?.().finally(() => {
      if (_requestFns.length > 0) recursion(_requestFns.pop())
    })
  }

  const _requestFns = [...requestFns]

  // 限制最大并发量
  for (let i = 0; i < limit && _requestFns.length > 0; i++) {
    recursion(_requestFns.pop())
  }
}
```

<!-- more -->

**测试用例:**

```ts
type RequestFn = () => Promise<string | void>
type CreateRequest = (delay: number) => RequestFn

// 模拟一个异步请求函数
const createRequest: CreateRequest = delay => {
  return async () => {
    const res = await new Promise(resolve => {
      setTimeout(() => resolve('done'), delay)
    })
    console.log(res)
  }
}

const requestFns: RequestFn[] = []

for (let i = 0; i < 10; i++) {
  requestFns.push(createRequest(1000))
}

concurrentRequest(requestFns, 3)
```
